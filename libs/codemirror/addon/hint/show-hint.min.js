// Minimal implementation of CodeMirror show-hint (lightweight, offline-friendly)
// This provides CodeMirror.showHint(cm, getHints, options) and a simple UI.
(function(mod) { if (typeof exports == "object" && typeof module == "object") mod(require("../../codemirror"));
  else if (typeof define == "function" && define.amd) define(["../../codemirror"], mod);
  else mod(window.CodeMirror);
})(function(CodeMirror) {
  if (!CodeMirror) return;

  function createElement(tag, className, text) {
    var el = document.createElement(tag);
    if (className) el.className = className;
    if (text) el.textContent = text;
    return el;
  }

  // Simple language-specific suggestion lists (expand as needed)
  var HTML_TAGS = [
    ['a','link element'],['abbr','abbreviation'],['address','contact info'],['area','image map area'],['article','article section'],['aside','complementary'],['audio','audio element'],['b','bold text'],['base','base URL'],['bdi','isolate text direction'],['bdo','override text direction'],['blockquote','quoted section'],['body','document body'],['br','line break'],['button','button control'],['canvas','drawing surface'],['caption','table caption'],['cite','citation'],['code','code snippet'],['col','table column'],['colgroup','table columns'],['data','machine-readable value'],['datalist','input suggestions'],['dd','description data'],['del','deleted text'],['details','additional info'],['dfn','definition term'],['dialog','dialog box'],['div','container'],['dl','description list'],['dt','description term'],['em','emphasis'],['embed','external resource'],['fieldset','form group'],['figcaption','figure caption'],['figure','figure element'],['footer','footer section'],['form','form container'],['h1','heading 1'],['h2','heading 2'],['h3','heading 3'],['h4','heading 4'],['h5','heading 5'],['h6','heading 6'],['head','document head'],['header','header section'],['hr','horizontal rule'],['html','root element'],['i','italic text'],['iframe','inline frame'],['img','image'],['input','form input'],['ins','inserted text'],['kbd','keyboard input'],['label','form label'],['legend','fieldset legend'],['li','list item'],['link','stylesheet link'],['main','main content'],['map','image map'],['mark','highlight text'],['meta','metadata'],['meter','measurement'],['nav','navigation region'],['noscript','fallback when JS disabled'],['object','embedded object'],['ol','ordered list'],['optgroup','option group'],['option','select option'],['output','calculation result'],['p','paragraph'],['param','object parameter'],['picture','responsive image'],['pre','preformatted text'],['progress','progress bar'],['q','inline quote'],['rp','ruby parentheses'],['rt','ruby text'],['ruby','ruby annotation'],['s','strikethrough'],['samp','sample output'],['script','script include'],['section','section'],['select','select control'],['small','small print'],['source','media source'],['span','inline container'],['strong','strong importance'],['style','style block'],['sub','subscript'],['summary','details summary'],['sup','superscript'],['table','table container'],['tbody','table body'],['td','table cell'],['template','client-side template'],['textarea','multi-line input'],['tfoot','table footer'],['th','table header'],['thead','table head'],['time','time value'],['title','document title'],['tr','table row'],['track','text track'],['u','underline'],['ul','unordered list'],['var','variable'],['video','video element'],['wbr','word break opportunity']
  ];

  var CSS_PROPS = [
    ['align-content','alignment of flex lines'],['align-items','align flex items'],['align-self','align single item'],['animation','animation shorthand'],['animation-delay','delay animation'],['animation-direction','animation direction'],['animation-duration','duration'],['animation-fill-mode','fill mode'],['animation-iteration-count','iterations'],['animation-name','keyframes name'],['animation-play-state','play state'],['animation-timing-function','timing function'],['backface-visibility','3d visibility'],['background','background shorthand'],['background-attachment','attachment'],['background-clip','clip region'],['background-color','background color'],['background-image','image'],['background-origin','origin'],['background-position','position'],['background-repeat','repeat'],['background-size','size'],['border','border shorthand'],['border-bottom','bottom border'],['border-bottom-color','bottom color'],['border-bottom-left-radius','radius'],['border-bottom-right-radius','radius'],['border-bottom-style','style'],['border-bottom-width','width'],['border-collapse','table borders'],['border-color','color'],['border-image','image border'],['border-image-outset','outset'],['border-image-repeat','repeat'],['border-image-slice','slice'],['border-image-source','source'],['border-image-width','width'],['border-left','left border'],['border-left-color','color'],['border-left-style','style'],['border-left-width','width'],['border-radius','radius'],['border-right','right border'],['border-right-color','color'],['border-right-style','style'],['border-right-width','width'],['border-spacing','spacing'],['border-style','style'],['border-top','top border'],['border-top-color','color'],['border-top-left-radius','radius'],['border-top-right-radius','radius'],['border-top-style','style'],['border-top-width','width'],['border-width','width'],['bottom','bottom offset'],['box-decoration-break','decoration break'],['box-shadow','shadow'],['box-sizing','box sizing'],['caption-side','caption position'],['clear','clear floats'],['clip','clipping region'],['color','text color'],['column-count','columns number'],['column-fill','column fill'],['column-gap','gap'],['column-rule','column rule shorthand'],['column-rule-color','rule color'],['column-rule-style','rule style'],['column-rule-width','rule width'],['columns','columns shorthand'],['column-span','span columns'],['column-width','width'],['content','generated content'],['counter-increment','counter increment'],['counter-reset','counter reset'],['cursor','mouse cursor'],['direction','text direction'],['display','display type'],['filter','visual effects'],['flex','flex shorthand'],['flex-basis','initial main size'],['flex-direction','direction'],['flex-flow','flow shorthand'],['flex-grow','grow factor'],['flex-shrink','shrink factor'],['flex-wrap','wrap'],['float','float elements'],['font','font shorthand'],['font-family','font family'],['font-feature-settings','features'],['font-kerning','kerning'],['font-size','font size'],['font-size-adjust','size adjust'],['font-stretch','stretch'],['font-style','style'],['font-variant','variant'],['font-weight','weight'],['gap','gap in flex/grid'],['grid','grid shorthand'],['grid-area','grid area'],['grid-auto-columns','auto columns'],['grid-auto-flow','auto flow'],['grid-auto-rows','auto rows'],['grid-column','grid column shorthand'],['grid-column-end','column end'],['grid-column-gap','column gap'],['grid-column-start','column start'],['grid-gap','grid gap'],['grid-row','grid row shorthand'],['grid-row-end','row end'],['grid-row-gap','row gap'],['grid-row-start','row start'],['grid-template','template shorthand'],['grid-template-areas','areas'],['grid-template-columns','columns'],['grid-template-rows','rows'],['height','height'],['justify-content','justify items'],['left','left offset'],['letter-spacing','spacing between letters'],['line-height','line height'],['list-style','list style shorthand'],['list-style-image','list image'],['list-style-position','position'],['list-style-type','type'],['margin','margin shorthand'],['margin-bottom','margin bottom'],['margin-left','margin left'],['margin-right','margin right'],['margin-top','margin top'],['max-height','max height'],['max-width','max width'],['min-height','min height'],['min-width','min width'],['object-fit','fit content'],['object-position','position'],['opacity','opacity level'],['order','flex order'],['outline','outline shorthand'],['outline-color','outline color'],['outline-offset','offset'],['outline-style','outline style'],['outline-width','outline width'],['overflow','overflow'],['overflow-wrap','wrap long words'],['overflow-x','overflow x'],['overflow-y','overflow y'],['padding','padding shorthand'],['padding-bottom','padding bottom'],['padding-left','padding left'],['padding-right','padding right'],['padding-top','padding top'],['page-break-after','page break after'],['page-break-before','page break before'],['perspective','3d perspective'],['perspective-origin','origin'],['pointer-events','pointer handling'],['position','positioning'],['quotes','quotes style'],['resize','resizing'],['right','right offset'],['scroll-behavior','smooth scrolling'],['tab-size','tab size'],['table-layout','table layout'],['text-align','alignment'],['text-decoration','decoration'],['text-decoration-color','decoration color'],['text-decoration-line','decoration line'],['text-decoration-style','decoration style'],['text-indent','indent'],['text-justify','justify method'],['text-overflow','overflow handling'],['text-shadow','text shadow'],['text-transform','transform case'],['top','top offset'],['transform','transform functions'],['transform-origin','origin'],['transform-style','3d style'],['transition','transition shorthand'],['transition-delay','delay'],['transition-duration','duration'],['transition-property','property'],['transition-timing-function','timing'],['unicode-bidi','unicode handling'],['user-select','selectable text'],['vertical-align','vertical alignment'],['visibility','visibility'],['white-space','whitespace handling'],['widows','minimum lines in page'],['width','width'],['word-break','word break'],['word-spacing','word spacing'],['word-wrap','word wrap'],['z-index','stack order']
  ];

  var JS_WORDS = [
    ['await','await expression'],['break','break statement'],['case','switch case'],['catch','catch block'],['class','class declaration'],['const','constant'],['continue','continue loop'],['debugger','debugger statement'],['default','default case'],['delete','delete operator'],['do','do-while loop'],['else','else branch'],['export','export statement'],['extends','class inheritance'],['finally','finally block'],['for','for loop'],['function','function declaration'],['if','if statement'],['import','import statement'],['in','in operator'],['instanceof','instanceof operator'],['let','let declaration'],['new','create instance'],['return','return statement'],['super','super call'],['switch','switch statement'],['this','current context'],['throw','throw exception'],['try','try block'],['typeof','type of'],['var','var declaration'],['void','void operator'],['while','while loop'],['with','with statement'],['yield','yield expression'],['Promise','Promise object'],['Array','Array object'],['Object','Object'],['Map','Map collection'],['Set','Set collection'],['WeakMap','WeakMap'],['WeakSet','WeakSet'],['JSON','JSON global'],['Math','Math object'],['Date','Date object'],['RegExp','RegExp object'],['console','console object'],['fetch','fetch API'],['setTimeout','timers'],['setInterval','timers'],['clearTimeout','timers'],['parseInt','parse integer'],['parseFloat','parse float'],['Number','Number object'],['String','String object'],['Boolean','Boolean object'],['Symbol','Symbol primitive'],['BigInt','BigInt type'],['isNaN','NaN check'],['isFinite','finite check'],['encodeURI','encode URI'],['decodeURI','decode URI'],['encodeURIComponent','encode component'],['decodeURIComponent','decode component'],['URL','URL class'],['URLSearchParams','URL params'],['requestAnimationFrame','animation frame'],['cancelAnimationFrame','cancel frame'],['performance','performance API'],['Intl','internationalization'],['setImmediate','immediate task'],['clearInterval','clear interval'],['atob','base64 decode'],['btoa','base64 encode'],['alert','alert dialog'],['prompt','prompt dialog'],['confirm','confirm dialog'],['document.querySelector','select element'],['document.querySelectorAll','select all elements'],['document.getElementById','get element by id'],['addEventListener','attach event'],['removeEventListener','remove event'],['classList','element class list'],['appendChild','append node'],['removeChild','remove node'],['createElement','create element'],['createTextNode','create text node'],['cloneNode','clone node'],['nodeValue','node value'],['textContent','text content'],['innerHTML','inner HTML'],['outerHTML','outer HTML'],['parentNode','parent node'],['childNodes','child nodes'],['firstChild','first child'],['lastChild','last child'],['previousSibling','previous sibling'],['nextSibling','next sibling'],['insertBefore','insert node before'],['replaceChild','replace node'],['getAttribute','get attribute'],['setAttribute','set attribute'],['removeAttribute','remove attribute'],['hasAttribute','has attribute'],['className','class name'],['style','inline style'],['dataset','data attributes'],['localStorage','local storage'],['sessionStorage','session storage'],['indexedDB','indexed DB'],['performance.now','high-res time'],['Promise.resolve','resolve promise'],['Promise.reject','reject promise'],['Promise.all','all promises'],['Promise.race','race promises'],['async','async function'],['await','await expression'],['then','then handler'],['catch','catch handler'],['finally','finally handler'],['Map.prototype.set','map set'],['Map.prototype.get','map get'],['Array.prototype.push','push array'],['Array.prototype.pop','pop array'],['Array.prototype.shift','shift array'],['Array.prototype.unshift','unshift array'],['Array.prototype.slice','slice array'],['Array.prototype.splice','splice array'],['Array.prototype.forEach','iterate array'],['Array.prototype.map','map array'],['Array.prototype.filter','filter array'],['Array.prototype.reduce','reduce array'],['String.prototype.slice','slice string'],['String.prototype.substring','substring'],['String.prototype.replace','replace string'],['JSON.stringify','serialize'],['JSON.parse','parse'],['Math.random','random number'],['Math.floor','floor'],['Math.ceil','ceil'],['Math.round','round'],['Number.isInteger','is integer'],['Object.keys','object keys'],['Object.values','object values'],['Object.entries','object entries'],['Object.assign','assign objects'],['Reflect','reflection API'],['Proxy','proxy object'],['Symbol.iterator','iterator symbol'],['Symbol.asyncIterator','async iterator'],['BigInt.asIntN','bigint op'],['Intl.DateTimeFormat','date formatting'],['Intl.NumberFormat','number formatting'],['URL.createObjectURL','blob url'],['Blob','Blob object'],['FileReader','read files'],['FormData','form data'],['Event','event object'],['CustomEvent','custom event'],['MutationObserver','DOM mutation observer'],['IntersectionObserver','intersection observer'],['ResizeObserver','resize observer']
  ];

  function detectInnerMode(cm, cur) {
    try {
      if (CodeMirror.innerMode) {
        var token = cm.getTokenAt(cur);
        var inner = CodeMirror.innerMode(cm.getMode(), token.state);
        if (inner && inner.mode && inner.mode.name) return inner.mode.name; // 'xml', 'javascript', 'css', etc.
      }
    } catch(e){}
    // fallback on option
    var m = cm.getOption && cm.getOption('mode');
    if (typeof m === 'string') return m;
    return null;
  }

  function buildHintsFromList(list, cur, start, end) {
    var q = cur || '';
    var out = [];
    var seen = Object.create(null);
    for (var i=0;i<list.length;i++){
      var entry = list[i];
      var item = entry[0];
      var desc = entry[1] || '';
      var snippet = entry[2] || null;
      if (item.indexOf(q) === 0 && !seen[item]) { seen[item]=true; out.push({text:item, display:item, desc:desc, snippet:snippet}); }
    }
    return {list: out, from: CodeMirror.Pos(start.line, start.ch), to: CodeMirror.Pos(end.line, end.ch)};
  }

  function getHints(cm, options) {
    var cur = cm.getCursor(), token = cm.getTokenAt(cur);
    var start = {line: cur.line, ch: token.start}, end = {line: cur.line, ch: cur.ch};
    var curWord = token.string.slice(0, end.ch - start.ch) || '';
    var modeName = detectInnerMode(cm, cur) || '';
    modeName = (modeName + '').toLowerCase();
    if (modeName.indexOf('xml') !== -1 || modeName.indexOf('html') !== -1) {
      return buildHintsFromList(HTML_TAGS, curWord, start, end);
    } else if (modeName.indexOf('css') !== -1) {
      return buildHintsFromList(CSS_PROPS, curWord, start, end);
    } else if (modeName.indexOf('javascript') !== -1 || modeName.indexOf('ecma') !== -1) {
      return buildHintsFromList(JS_WORDS, curWord, start, end);
    }
    // fallback: anyword scan through document
    var list = [];
    var seen = Object.create(null);
    cm.eachLine(function(lineHandle){
      var s = lineHandle.text.split(/[^A-Za-z0-9_\$\-]/);
      for (var i=0;i<s.length;i++){ var w=s[i]; if (w && w.indexOf(curWord)===0 && !seen[w]){ seen[w]=true; list.push({text:w, display:w, desc:''}); } }
    });
    list.sort(function(a,b){ return a.text<b.text?-1:1; });
    return {list:list, from: CodeMirror.Pos(cur.line, start.ch), to: CodeMirror.Pos(cur.line, end.ch)};
  }

  // Snippets map: key -> [display, desc, snippet]
  var SNIPPETS = {
    'img': ['img', 'image tag', '<img src="${1}" alt="${2}">'],
    'link': ['link', 'stylesheet', '<link rel="stylesheet" href="${1}">'],
    'script': ['script', 'script src', '<script src="${1}"></script>'],
    'a': ['a', 'anchor', '<a href="${1}">${2}</a>'],
    'textarea': ['textarea','multiline input','<textarea name="${1}">${2}</textarea>']
  };

  function hintContainer(cm, hints, options) {
    var widget = createElement('div', 'CodeMirror-hints');
    var header = createElement('div','CodeMirror-hints-header','Sugestões – pressione Ctrl+Space');
    widget.appendChild(header);
    var ul = createElement('ul', 'CodeMirror-hints-list');
    widget.appendChild(ul);
    var selected = 0;
    function render() {
      ul.innerHTML = '';
      for (var i = 0; i < hints.list.length; i++) {
        var item = hints.list[i];
        var li = createElement('li', 'CodeMirror-hint');
        if (i === selected) li.className += ' CodeMirror-hint-active';
        // icon (FontAwesome) based on hint source
        var icon = createElement('span', 'hint-icon');
        // inline SVG icons (tiny, offline-friendly)
        var svgHTML = '';
        var t = (item.text || '').toLowerCase();
        if (/^(div|span|a|p|img|ul|li|button|input|form|label|script|link|meta|nav|header|footer|section|article|aside|main|figure|figcaption)$/i.test(t)){
          svgHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2" stroke="#f0c674" stroke-width="1.5"/><path d="M7 12h10" stroke="#f0c674" stroke-width="1.5" stroke-linecap="round"/></svg>';
        } else if (/^(display|position|width|height|color|background|margin|padding|font-size|flex|grid|align-items|grid-template|border|transform|transition|animation)$/i.test(t)){
          svgHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="16" height="16" rx="2" stroke="#6ad1ff" stroke-width="1.5"/><path d="M8 8h8v8H8z" stroke="#6ad1ff" stroke-width="1"/></svg>';
        } else {
          svgHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" stroke="#ffd86b" stroke-width="1.5"/><path d="M9 12h6" stroke="#ffd86b" stroke-width="1.5" stroke-linecap="round"/></svg>';
        }
        icon.innerHTML = svgHTML;
        li.appendChild(icon);
        var span = createElement('span', 'hint-main', item.display || item.text);
        li.appendChild(span);
  if (item.desc) { var sd = createElement('small','hint-desc', item.desc); li.appendChild(sd); }
  // show shortcut if snippet available
  if (item.snippet) { var ks = createElement('span','hint-shortcut','Tab'); li.appendChild(ks); }
        (function(i){ li.addEventListener('mousedown', function(e){ e.preventDefault(); select(i); apply(); }); })(i);
        ul.appendChild(li);
      }
    }
    function select(i) { selected = (i + hints.list.length) % hints.list.length; render(); }
    function up(){ select(selected - 1); }
    function down(){ select(selected + 1); }
    function insertSnippet(cm, snippet, from, to) {
      if (!snippet) return;
      // find first placeholder ${1}
      var firstMatch = snippet.match(/\$\{(\d+)\}/);
      var firstIndex = firstMatch ? snippet.indexOf(firstMatch[0]) : -1;
      // build the text to insert (remove placeholders)
      var plain = snippet.replace(/\$\{\d+\}/g, '');
      cm.replaceRange(plain, from, to);
      if (firstIndex >= 0) {
        // compute pos from offset
        var pos = posFromOffset(from, plain, firstIndex);
        cm.setSelection(pos, pos);
      }
    }

    function posFromOffset(fromPos, text, offset) {
      // offset is number of chars from start of inserted text where cursor should go
      var lines = text.slice(0, offset).split('\n');
      var lineOffset = lines.length - 1;
      var ch = lines[lines.length -1].length;
      return CodeMirror.Pos(fromPos.line + lineOffset, (lineOffset === 0 ? fromPos.ch : ch));
    }

    function apply() {
      var completion = hints.list[selected];
      if (!completion) return close();
      if (completion.snippet) {
        insertSnippet(cm, completion.snippet, hints.from, hints.to);
      } else {
        cm.replaceRange(completion.text, hints.from, hints.to);
      }
      close();
    }
    function close() {
      if (widget.parentNode) widget.parentNode.removeChild(widget);
      cm.focus();
      if (cm.state && cm.state.showHint && cm.state.showHint.close) cm.state.showHint.close();
      cm.state.showHint = null;
      window.removeEventListener('resize', close);
      cm.off('keydown', keyHandler);
    }
    function keyHandler(cmInstance, e) {
      var kc = e.keyCode;
      if (kc === 38) { e.preventDefault(); up(); }
      else if (kc === 40) { e.preventDefault(); down(); }
      else if (kc === 13 || kc === 9) { e.preventDefault(); apply(); }
      else if (kc === 27) { e.preventDefault(); close(); }
    }

    widget._close = close;
    widget._select = select;

    render();

    cm.on('keydown', keyHandler);
    window.addEventListener('resize', close);
    return widget;
  }

  CodeMirror.showHint = function(cm, getHints, options) {
    if (cm.state && cm.state.showHint) return;
    getHints = getHints || getHints && typeof getHints === 'function' ? getHints : getHints;
    var hints = (typeof getHints === 'function') ? getHints(cm, options) : getHints;
    if (!hints || !hints.list || !hints.list.length) {
      // try language-aware default
      hints = getHints(cm, options) || getHints(cm, options);
    }
    if (!hints || !hints.list || !hints.list.length) return;
    var widget = hintContainer(cm, hints, options);
    var coords = cm.cursorCoords(hints.from, 'page');
    widget.style.position = 'absolute';
    widget.style.left = (coords.left) + 'px';
    widget.style.top = (coords.bottom + 2) + 'px';
    document.body.appendChild(widget);
    cm.state.showHint = {widget: widget, close: function(){ if (widget && widget._close) widget._close(); }};
    return cm.state.showHint;
  };

  // Register helpers for each language
  CodeMirror.registerHelper('hint', 'anyword', function(cm, options){ return getHints(cm, options); });
  CodeMirror.registerHelper('hint', 'html', function(cm, options){ return getHints(cm, options); });
  CodeMirror.registerHelper('hint', 'css', function(cm, options){ return getHints(cm, options); });
  CodeMirror.registerHelper('hint', 'javascript', function(cm, options){ return getHints(cm, options); });

});
